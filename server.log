require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');
const { initDatabase } = require('./database');
const { agendarBackupAutomatico } = require('./utils/backup');

const app = express();
const PORT = process.env.PORT || 3000;

// Verificar JWT_SECRET
if (!process.env.JWT_SECRET) {
  console.warn('âš ï¸  AVISO: JWT_SECRET nÃ£o definido! Usando valor padrÃ£o (NÃƒO SEGURO PARA PRODUÃ‡ÃƒO)');
  process.env.JWT_SECRET = 'netiz_orcamento_secret_key_2024_super_seguro';
}

console.log('ğŸ”‘ JWT_SECRET configurado:', process.env.JWT_SECRET ? 'SIM' : 'NÃƒO');
console.log('ğŸŒ NODE_ENV:', process.env.NODE_ENV || 'development');

// Middlewares
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static('public'));

// Inicializar banco de dados
initDatabase()
  .then(() => {
    console.log('âœ… Database pronto!');
    
    // Agendar backup automÃ¡tico
    agendarBackupAutomatico();
    
    // Rotas da API
    app.use('/api/auth', require('./routes/auth'));
    app.use('/api/usuarios', require('./routes/usuarios'));
    app.use('/api/departamentos', require('./routes/departamentos'));
    app.use('/api/categorias', require('./routes/categorias'));
    app.use('/api/periodos', require('./routes/periodos'));
    app.use('/api/orcamentos', require('./routes/orcamentos'));
    app.use('/api/contestacoes', require('./routes/contestacoes'));
    app.use('/api/notificacoes', require('./routes/notificacoes'));
    app.use('/api/dashboard', require('./routes/dashboard'));
    app.use('/api/logs', require('./routes/logs'));
    app.use('/api/relatorios', require('./routes/relatorios'));
    app.use('/api/backup', require('./routes/backup'));

    // Rota principal
    app.get('/', (req, res) => {
      res.sendFile(path.join(__dirname, 'public', 'index.html'));
    });

    // Rota de saÃºde
    app.get('/health', (req, res) => {
      res.json({ 
        status: 'ok', 
        timestamp: new Date().toISOString(),
        jwt_configured: !!process.env.JWT_SECRET 
      });
    });

    // Iniciar servidor
    app.listen(PORT, () => {
      console.log('\n' + '='.repeat(60));
      console.log('ğŸš€ Sistema de OrÃ§amento Netiz');
      console.log('='.repeat(60));
      console.log(`âœ… Servidor rodando em http://localhost:${PORT}`);
      console.log(`ğŸ“§ Login: fagner@netiz.com.br`);
      console.log(`ğŸ”‘ Senha: netiz2024`);
      console.log(`ğŸ“§ Ou: admin@netiz.com.br / admin123`);
      console.log('='.repeat(60) + '\n');
    });
  })
  .catch(err => {
    console.error('âŒ Erro ao inicializar database:', err);
    process.exit(1);
  });

// Tratamento de erros nÃ£o capturados
process.on('uncaughtException', (err) => {
  console.error('âŒ Erro nÃ£o capturado:', err);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ Promise rejeitada nÃ£o tratada:', reason);
});
